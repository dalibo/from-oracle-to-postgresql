<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.106.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Partitioning # PostgreSQL accepts declarative partitioning since version 10 and things keep getting better from major release to another. A table is devided into partitions as declared by its partitioned key, which is decisive when defining the model and could be costly to change during the life of the data."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Partitioning"><meta property="og:description" content="Partitioning # PostgreSQL accepts declarative partitioning since version 10 and things keep getting better from major release to another. A table is devided into partitions as declared by its partitioned key, which is decisive when defining the model and could be costly to change during the life of the data."><meta property="og:type" content="article"><meta property="og:url" content="https://example.com/partitioning/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-11-21T17:42:55+01:00"><meta property="og:site_name" content="From Oracle to PostgreSQL"><title>Partitioning</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=alternate hreflang=fr href=https://example.com/fr/reprise-des-partitions/ title="Reprise des partitions"><link rel=stylesheet href=/book.min.a0b1bf814d7fc28217ec0eea7c47371480fb4f325cec9eb1ae1aa1097d715ec7.css integrity="sha256-oLG/gU1/woIX7A7qfEc3FID7TzJc7J6xrhqhCX1xXsc="><script defer src=/en.search.min.95c92b6d1acfeccbfbe5b5bcabbf661d49ac6c98314c68e7361dc54efea924c2.js integrity="sha256-lckrbRrP7Mv75bW8q79mHUmsbJgxTGjnNh3FTv6pJMI="></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/><img src=/images/logo.png alt=Logo><span>From Oracle to PostgreSQL</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://example.com/general-differences-between-oracle-and-postgresql/>General differences</a><ul></ul></li><li><input type=checkbox id=section-88c4d5ca464ed2de3d87c4f315803bbb class=toggle checked>
<label for=section-88c4d5ca464ed2de3d87c4f315803bbb class="flex justify-between"><a href=https://example.com/porting-the-database-schema-to-postgresql/>Porting database objects</a></label><ul><li><a href=https://example.com/datatypes/>Datatypes</a></li><li><a href=https://example.com/table-migration/>Table migration</a></li><li><a href=https://example.com/views-migration/>Views migration</a></li><li><a href=https://example.com/sequences-migration/>Sequences migration</a></li><li><a href=https://example.com/index-migration/>Index migration</a></li><li><a href=https://example.com/partitioning/ class=active>Partitioning</a></li></ul></li><li><input type=checkbox id=section-b7e37e1862e6db598e5e41747363d74a class=toggle>
<label for=section-b7e37e1862e6db598e5e41747363d74a class="flex justify-between"><a href=https://example.com/porting-sql-queries/>Porting SQL queries</a></label><ul><li><a href=https://example.com/specificities-on-data-types/>Specificities on Data types</a></li><li><a href=https://example.com/joins/>Joins</a></li><li><a href=https://example.com/conditional-expressions/>Conditional expressions</a></li><li><a href=https://example.com/hierarchical-querying/>Hierarchical querying</a></li><li><a href=https://example.com/transaction-management/>Transaction management</a></li></ul></li><li><input type=checkbox id=section-cfaa4d420be7e860c2f111a313f9a252 class=toggle>
<label for=section-cfaa4d420be7e860c2f111a313f9a252 class="flex justify-between"><a href=https://example.com/pl-sql-to-pl-pgsql-porting/>PL/SQL to PL/pgSQL porting</a></label><ul><li><a href=https://example.com/porting-procedures-and-functions/>Porting procedures and functions</a></li><li><a href=https://example.com/triggers-conversion/>Triggers conversion</a></li><li><a href=https://example.com/control-structures/>Control structures</a></li><li><a href=https://example.com/pl-sql-code-conversion/>PL/SQL code conversion</a></li><li><a href=https://example.com/cursors/>Cursors</a></li><li><a href=https://example.com/pl-sql-specificities/>PL/SQL specificities</a></li><li><a href=https://example.com/oracles-packages/>Oracle's packages</a></li></ul></li><li><a href=https://example.com/contact-us/>Contact us</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Partitioning</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#partitioning>Partitioning</a><ul><li><a href=#list-partitioning>List Partitioning</a></li><li><a href=#range-partitioning>Range Partitioning</a></li><li><a href=#automatic-range-partitioning>Automatic Range Partitioning</a></li><li><a href=#hash-partitioning>Hash Partitioning</a></li><li><a href=#composite-partitioning>Composite Partitioning</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h2 id=partitioning>Partitioning
<a class=anchor href=#partitioning>#</a></h2><p>PostgreSQL accepts declarative partitioning since version 10 and things keep
getting better from major release to another. A table is devided into partitions
as declared by its partitioned key, which is decisive when defining the model
and could be costly to change during the life of the data. Unlike Oracle, the
partitioned table must be create separately before the partitions can be
defined.</p><h3 id=list-partitioning>List Partitioning
<a class=anchor href=#list-partitioning>#</a></h3><p>The following partitioned table for Oracle:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t1 (c1 integer, c2 varchar2(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> LIST (c1) (
</span></span><span style=display:flex><span>    PARTITION t1_a <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>    PARTITION t1_b <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    PARTITION t1_default <span style=color:#66d9ef>VALUES</span> (<span style=color:#66d9ef>DEFAULT</span>)
</span></span><span style=display:flex><span>  );
</span></span></code></pre></div><p>will be converted to this in PostgreSQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t1(c1 integer, c2 varchar(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> LIST (c1) ;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t1_a PARTITION <span style=color:#66d9ef>OF</span> t1 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>IN</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t1_b PARTITION <span style=color:#66d9ef>OF</span> t1 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>IN</span> (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t1_default PARTITION <span style=color:#66d9ef>of</span> t1 <span style=color:#66d9ef>DEFAULT</span>;
</span></span></code></pre></div><h3 id=range-partitioning>Range Partitioning
<a class=anchor href=#range-partitioning>#</a></h3><p>Oracle allows range declaration using <code>LESS THAN</code> expression in order to join
the lower bound of one partition with the upper bound of another partition. Data
values are strictly between <code>-∞</code> and last defined upper bound.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t2 (c1 integer, c2 varchar2(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> RANGE (c1) (
</span></span><span style=display:flex><span>    PARTITION t2_a <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> (<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>    PARTITION t2_b <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> (<span style=color:#ae81ff>100</span>),
</span></span><span style=display:flex><span>    PARTITION t2_c <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> (<span style=color:#66d9ef>MAXVALUE</span>)
</span></span><span style=display:flex><span>  );
</span></span></code></pre></div><p>Each bounds of a partition must be specified when declaring with PostgreSQL, the
upper bound is excluded from partition range. The above partitioned table will
be converted this way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t2 (c1 integer, c2 varchar(<span style=color:#ae81ff>100</span>)) PARTITION <span style=color:#66d9ef>BY</span> RANGE (c1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t2_a PARTITION <span style=color:#66d9ef>OF</span> t2 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>MINVALUE</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t2_b PARTITION <span style=color:#66d9ef>OF</span> t2 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t2_c PARTITION <span style=color:#66d9ef>OF</span> t2 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#66d9ef>MAXVALUE</span>);
</span></span></code></pre></div><h3 id=automatic-range-partitioning>Automatic Range Partitioning
<a class=anchor href=#automatic-range-partitioning>#</a></h3><p>Oracle supports automatic partition addition using <code>INTERVAL</code> clause and an
interval expression like <code>DAY TO SECOND</code> or <code>YEAR TO MONTH</code>. In example below,
only the first partition is needed as a transition point; all data inserted will
cause a partition to be created when value is greater that the upper bound of
the transition point.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t2_auto (c1 number(<span style=color:#ae81ff>6</span>), c2 date)
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> RANGE (c2) INTERVAL (NUMTOYMINTERVAL(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;MONTH&#39;</span>)) (
</span></span><span style=display:flex><span>    PARTITION t2_part <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span>
</span></span><span style=display:flex><span>      (TO_DATE(<span style=color:#e6db74>&#39;01-JAN-2020&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>))
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> t2_auto <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, TO_DATE(<span style=color:#e6db74>&#39;01-DEC-2000&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> t2_auto <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>2</span>, TO_DATE(<span style=color:#e6db74>&#39;01-OCT-2022&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> t2_auto <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>3</span>, TO_DATE(<span style=color:#e6db74>&#39;01-DEC-2022&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>));
</span></span></code></pre></div><p>The <code>USER_TAB_PARTITIONS</code> view describes table definition, including new
partitions with a generated name.</p><table><thead><tr><th>TABLE_NAME</th><th>PARTITION_NAME</th><th>HIGH_VALUE</th></tr></thead><tbody><tr><td>T2_AUTO</td><td>T2_PART</td><td>TO_DATE(&lsquo;2020-01-01&rsquo;, &lsquo;SYYYY-MM-DD&rsquo;)</td></tr><tr><td>T2_AUTO</td><td>SYS_P472681</td><td>TO_DATE(&lsquo;2021-11-01&rsquo;, &lsquo;SYYYY-MM-DD&rsquo;)</td></tr><tr><td>T2_AUTO</td><td>SYS_P472682</td><td>TO_DATE(&lsquo;2023-01-01&rsquo;, &lsquo;SYYYY-MM-DD&rsquo;)</td></tr></tbody></table><p>This automatique partition management feature is not available natively with
PostgreSQL. However, it is possible to mimic the behaviour presented above using
the <strong>pg_partman</strong> project. This extension relies on configuration tables and a
maintenance routine to detect partitioned tables requiring new partitions.</p><p>Unlike Oracle, a new row outside one of existing bound is inserted into default
partition. The maintenance routine takes care of moving rows asynchronously
according to their values in a new partition.</p><p>Here an example with the previous table <code>t2_auto</code>, which can be managed by
<code>pg_partman</code>. The <code>premake</code> option allows to prepare <code>n</code> partitions from the
interval next to the time of the function call.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t2_auto (c1 integer, c2 date)
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> RANGE (c2);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>SCHEMA</span> partman;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> EXTENSION pg_partman <span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>SCHEMA</span> partman;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> partman.create_parent(
</span></span><span style=display:flex><span>  p_parent_table <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;public.t2_auto&#39;</span>,
</span></span><span style=display:flex><span>  p_control <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;c2&#39;</span>,
</span></span><span style=display:flex><span>  p_type <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;native&#39;</span>,
</span></span><span style=display:flex><span>  p_interval <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;monthly&#39;</span>,
</span></span><span style=display:flex><span>  p_premake <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>The following query show the distribution of three rows in existing partitions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> t2_auto <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;2000-12-01&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> t2_auto <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;2022-10-01&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> t2_auto <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;2022-12-01&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> tableoid::regclass, <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t2_auto;
</span></span><span style=display:flex><span><span style=color:#75715e>--     tableoid     | c1 |     c2     
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- -----------------+----+------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- t2_auto_p2022_10 |  2 | 2022-10-01
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- t2_auto_default  |  1 | 2000-12-01
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- t2_auto_default  |  3 | 2022-12-01
</span></span></span></code></pre></div><p><code>pg_partman</code> offers a series of maintenance functions to add new partitions and
spread rows from the default partitions to more relevant partitions. These
operations must be scheduled by an external orchestrator (<em>cron</em>, pg_cron_,
etc.) or using the background process provided by the extension. This last
solution requires setting the <code>pg_parman_bgw</code> value to the
<code>shared_preload_libraries</code> parameter and restarting the instance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Monitor for data getting inserted into parent/default tables
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> partman.check_default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Move data from these parent/default tables into the proper children
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> partman.partition_data_time(p_parent_table <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;public.t2_auto&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Automatically create child tables for partition sets configured to use it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CALL</span> partman.run_maintenance_proc();
</span></span></code></pre></div><p>The data is now in the correct partitions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> tableoid::regclass, <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t2_auto;
</span></span><span style=display:flex><span><span style=color:#75715e>--     tableoid     | c1 |     c2     
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- -----------------+----+------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- t2_auto_p2000_12 |  1 | 2000-12-01
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- t2_auto_p2022_10 |  2 | 2022-10-01
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- t2_auto_p2022_12 |  3 | 2022-12-01
</span></span></span></code></pre></div><h3 id=hash-partitioning>Hash Partitioning
<a class=anchor href=#hash-partitioning>#</a></h3><p>To evenly distribute the data between a finite number of partitions, Oracle and
PostgreSQL offer the same hash partitioning operation.</p><p>The following partitioned table with Oracle:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t3 (c1 integer, c2 varchar2(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> HASH (c1) (
</span></span><span style=display:flex><span>    PARTITION t3_a,
</span></span><span style=display:flex><span>    PARTITION t3_b,
</span></span><span style=display:flex><span>    PARTITION t3_c
</span></span><span style=display:flex><span>  );
</span></span></code></pre></div><p>Will be converted with PostgreSQL like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t3 (c1 integer, c2 varchar(<span style=color:#ae81ff>100</span>)) 
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> HASH (c1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t3_a PARTITION <span style=color:#66d9ef>OF</span> t3 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>WITH</span> (modulus <span style=color:#ae81ff>3</span>, remainder <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t3_b PARTITION <span style=color:#66d9ef>OF</span> t3 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>WITH</span> (modulus <span style=color:#ae81ff>3</span>, remainder <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t3_c PARTITION <span style=color:#66d9ef>OF</span> t3 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>WITH</span> (modulus <span style=color:#ae81ff>3</span>, remainder <span style=color:#ae81ff>2</span>);
</span></span></code></pre></div><p>When a new partition need to be added, especially to redistribute rows in a
larger number of partitions, Oracle chooses a partition according to its hashing
algorithm to divide the content in two parts and redistributes one of the halves
into the new partition.</p><p>With Oracle, the following instruction performs operations transparently:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> t3 <span style=color:#66d9ef>ADD</span> PARTITION t3_d;
</span></span></code></pre></div><p>With PostgreSQL, it is up to the administrator to select the source partition by
expanding the <code>modulus</code> and <code>remainder</code> options to split the two (or more)
subsets of data, each half will be moved into a new partition. This operation
requires getting a lock through a transaction while copying data to the two new
partitions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- Replacement of a partition by two subsets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> t3 DETACH PARTITION t3_c;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t3_c_0 PARTITION <span style=color:#66d9ef>OF</span> t3 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>WITH</span> (modulus <span style=color:#ae81ff>6</span>, remainder <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t3_c_3 PARTITION <span style=color:#66d9ef>OF</span> t3 <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>WITH</span> (modulus <span style=color:#ae81ff>6</span>, remainder <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Move lines
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> t3 <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> t3_c;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> t3_c;
</span></span><span style=display:flex><span><span style=color:#66d9ef>COMMIT</span>;
</span></span></code></pre></div><h3 id=composite-partitioning>Composite Partitioning
<a class=anchor href=#composite-partitioning>#</a></h3><p>All previous methods can be mixed to meet more precise partitioning needs, on
several levels of partitioned keys. Consider the following table with Oracle
has a high level of list partitioning and a low level of range partitioning,
also known as as composition partitioning or subpartitioning:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4 (c1 char(<span style=color:#ae81ff>1</span>), c2 date)
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> LIST (c1)
</span></span><span style=display:flex><span>  SUBPARTITION <span style=color:#66d9ef>BY</span> RANGE (c2) (
</span></span><span style=display:flex><span>    PARTITION t4_a <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;A&#39;</span>) (
</span></span><span style=display:flex><span>      SUBPARTITION t4_a_2020 <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> 
</span></span><span style=display:flex><span>        (TO_DATE(<span style=color:#e6db74>&#39;01-JAN-2021&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>)),
</span></span><span style=display:flex><span>      SUBPARTITION t4_a_2021 <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> 
</span></span><span style=display:flex><span>        (TO_DATE(<span style=color:#e6db74>&#39;01-JAN-2022&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>)),
</span></span><span style=display:flex><span>      SUBPARTITION t4_a_2022 <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> 
</span></span><span style=display:flex><span>        (TO_DATE(<span style=color:#e6db74>&#39;01-JAN-2023&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>))
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    PARTITION t4_b <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;B&#39;</span>) (
</span></span><span style=display:flex><span>      SUBPARTITION t4_b_2020 <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> 
</span></span><span style=display:flex><span>        (TO_DATE(<span style=color:#e6db74>&#39;01-JAN-2021&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>)),
</span></span><span style=display:flex><span>      SUBPARTITION t4_b_2021 <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> 
</span></span><span style=display:flex><span>        (TO_DATE(<span style=color:#e6db74>&#39;01-JAN-2022&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>)),
</span></span><span style=display:flex><span>      SUBPARTITION t4_b_2022 <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>LESS</span> <span style=color:#66d9ef>THAN</span> 
</span></span><span style=display:flex><span>        (TO_DATE(<span style=color:#e6db74>&#39;01-JAN-2023&#39;</span>,<span style=color:#e6db74>&#39;dd-MON-yyyy&#39;</span>))
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>  );
</span></span></code></pre></div><p>With PostgreSQL, it is possible to attach partitioned tables to another
partition table. Partitions define the final depth level. The previous example
will be rewritten like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4 (c1 char(<span style=color:#ae81ff>1</span>), c2 date)
</span></span><span style=display:flex><span>  PARTITION <span style=color:#66d9ef>BY</span> LIST (c1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_a PARTITION <span style=color:#66d9ef>OF</span> t4 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>IN</span> (<span style=color:#e6db74>&#39;A&#39;</span>) PARTITION <span style=color:#66d9ef>BY</span> RANGE (c2);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_a_2020 PARTITION <span style=color:#66d9ef>OF</span> t4_a 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>MINVALUE</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#e6db74>&#39;2021-01-01&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_a_2021 PARTITION <span style=color:#66d9ef>OF</span> t4_a 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#e6db74>&#39;2021-01-01&#39;</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#e6db74>&#39;2022-01-01&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_a_2022 PARTITION <span style=color:#66d9ef>OF</span> t4_a 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#e6db74>&#39;2022-01-01&#39;</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#e6db74>&#39;2023-01-01&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_b PARTITION <span style=color:#66d9ef>OF</span> t4 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>IN</span> (<span style=color:#e6db74>&#39;B&#39;</span>) PARTITION <span style=color:#66d9ef>BY</span> RANGE (c2);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_b_2020 PARTITION <span style=color:#66d9ef>OF</span> t4_b 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>MINVALUE</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#e6db74>&#39;2021-01-01&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_b_2021 PARTITION <span style=color:#66d9ef>OF</span> t4_b 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#e6db74>&#39;2021-01-01&#39;</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#e6db74>&#39;2022-01-01&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> t4_b_2022 PARTITION <span style=color:#66d9ef>OF</span> t4_b 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#e6db74>&#39;2022-01-01&#39;</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#e6db74>&#39;2023-01-01&#39;</span>);
</span></span></code></pre></div><hr><p>Partitioning is usually used for several purposes. The first one is performance.
If the partitioning is adequate and the queries correctly written in order to
take advantage of partitioning, then PostgreSQL will limit reads to only the
tables holding the candidate data, and not all partitions.</p><p>Another use case partitioning can fulfill is maintenance. Partitioning can ease
management of historical data. For example, if partitioning per year, when one
wants to get rid of data from a certain year, one should simply drop the
partition containing obsolete data. Furthermore, maintenance operations
(<code>VACUUM</code>, <code>ANALYZE</code>) will be easier.</p><p>However, declarative partitioning in PostgreSQL may have some shortcomings
compared to Oracle functionnalities. For example, foreign key constraints
defined with <code>ON DELETE ... CASCADE</code> can have surprising behaviors on
partitioned tables before version 15, when moving a row between two partitions
triggers the unwanted deletion of foreign key related rows.</p><p>References :</p><ul><li><a href=https://www.postgresql.org/docs/current/ddl-partitioning.html>Table Partitioning</a></li><li><a href=https://blog.anayrat.info/en/2021/09/01/partitioning-use-cases-with-postgresql/>Partitioning use cases with PostgreSQL</a></li><li><a href=https://github.com/pgpartman/pg_partman>Projet pg_partman</a></li><li><a href=https://github.com/postgres/postgres/commit/ba9a7e392171c83eb3332a757279e7088487f9a2>Release 15: Enforce foreign key correctly during cross-partition updates</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li><a href=https://example.com/fr/reprise-des-partitions/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
French</a></li></ul></div><div><a class="flex align-center" href=https://github.com/dalibo/from-oracle-to-postgresql/commit/0e0e39630a9315928b94eb8adbab6b0771fc83ec title='Last modified by Florent Jardin | November 21, 2022' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 21, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/dalibo/from-oracle-to-postgresql/edit/main/content.en/docs/schema/partitions.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#partitioning>Partitioning</a><ul><li><a href=#list-partitioning>List Partitioning</a></li><li><a href=#range-partitioning>Range Partitioning</a></li><li><a href=#automatic-range-partitioning>Automatic Range Partitioning</a></li><li><a href=#hash-partitioning>Hash Partitioning</a></li><li><a href=#composite-partitioning>Composite Partitioning</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>